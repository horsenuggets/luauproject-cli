name: Test install scripts

on:
  workflow_run:
    workflows: ["Publish release"]
    types:
      - completed
  workflow_dispatch:

jobs:
  test-install-scripts:
    name: Test install script on ${{ matrix.os }}
    runs-on: ${{ matrix.runner }}
    if: ${{ github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success' }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: linux
            runner: ubuntu-latest
          - os: macos
            runner: macos-latest
          - os: windows
            runner: windows-latest

    steps:
      - name: Install via script (Unix)
        if: runner.os != 'Windows'
        run: |
          curl -fsSL "https://raw.githubusercontent.com/horsenuggets/luauproject-cli/main/Scripts/Install.Unix.sh" | bash

      - name: Install via script (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          iwr "https://raw.githubusercontent.com/horsenuggets/luauproject-cli/main/Scripts/Install.Win.ps1" -useb | iex

      - name: Verify installation (Unix)
        if: runner.os != 'Windows'
        run: |
          if [ ! -f "$HOME/.luauproject-cli/bin/luauproject" ]; then
            echo "Executable not found at expected location."
            exit 1
          fi

          echo "Installation successful."
          "$HOME/.luauproject-cli/bin/luauproject" --help

      - name: Verify installation (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $installPath = "$env:USERPROFILE\.luauproject-cli\bin\luauproject.exe"
          if (-not (Test-Path $installPath)) {
            Write-Error "Executable not found at expected location."
            exit 1
          }

          Write-Host "Installation successful."
          & $installPath --help
